<!DOCTYPE html>
<html>
  <head>
    <style>
      .explainer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 7, 15, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
      }

      .explainer-content {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 2rem;
        border-radius: 15px;
        max-width: 600px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .explainer-content h2 {
        color: #00b1db;
        margin-bottom: 1.5rem;
      }

      .explainer-content p {
        margin-bottom: 1rem;
        line-height: 1.6;
      }

      .explainer-content ul {
        text-align: left;
        margin: 1rem 0;
        padding-left: 2rem;
      }

      .explainer-content li {
        margin: 0.5rem 0;
      }

      .free-music-note {
        font-weight: bold;
        color: #4caf50;
        font-size: 1.1em;
        margin-top: 1.5rem;
      }

      .explainer-close {
        background-color: #00b1db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 1.1em;
        cursor: pointer;
        margin-top: 1.5rem;
        transition: background-color 0.3s;
      }

      .explainer-close:hover {
        background-color: #0089a8;
      }

      .matrix-container {
        display: grid;
        gap: 2px;
        width: fit-content;
        background: #e0e0e0;
        margin-top: 20px;
      }

      .flag-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
      }

      .header-cell {
        background-color: #f0f0f0;
        border: 1px solid #00b1db;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        text-align: center;
        min-width: 100px;
        min-height: 100px;
      }

      .matrix-cell {
        background-color: #e0e0e0;
        border: 1px solid #5c5c5c;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.3s;
        min-width: 100px;
        min-height: 100px;
      }

      .matrix-cell:hover {
        background-color: #d0d0d0;
      }

      .matrix-cell:active {
        background-color: #c0c0c0;
      }

      .playing {
        background-color: #aad1da;
        box-shadow: 0 0 20px #00b1db;
        border-color: #00b1db;
      }

      .country-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .flag {
        font-size: 24px;
      }
      .cell {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin: 2px;
        padding: 10px;
        transition: background-color 0.3s;
      }

      .cell:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgb(0, 7, 15);
        padding: 80px;
        color: rgb(0, 7, 15);
      }
      #downloadButton {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #4caf50;
        color: white;
        padding: 15px 20px;
        border: none;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.3s;
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      }

      #downloadButton:hover {
        background-color: #45a049;
      }

      #downloadButton:active {
        background-color: #3d8b40;
      }

      .button-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 200px;
      }

      .button {
        padding: 15px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        box-sizing: border-box;
      }

      .stop-button {
        background-color: #ff4444;
        color: white;
      }

      .stop-button:hover {
        background-color: #ff6666;
      }

      .coffee-button {
        background-color: #ffdd00;
        padding: 10px;
      }

      .coffee-button:hover {
        background-color: #ffe633;
      }

      .coffee-button svg {
        width: 32px;
        height: 32px;
      }
      .visualization-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 20px;
      }

      #spectrogram {
        width: 512px;
        height: 150px;
        background: rgb(0, 7, 15);
      }

      .logo {
        width: 150px;
        height: 150px;
      }
    </style>
  </head>
  <body>
    <div id="explainer-overlay" class="explainer-overlay">
      <div class="explainer-content">
        <h2>Welcome to the Music Hybridisation Lab! üéµ</h2>
        <p>
          This interactive tool lets you explore musical fusions between
          different cultures. Click on any cell in the matrix to hear unique
          hybrid compositions.
        </p>
        <ul>
          <li>Diagonal cells: Traditional music from a single country</li>
          <li>
            Other cells: Hybrid compositions combining two musical traditions
          </li>
          <li>Use arrow keys to navigate the matrix</li>
        </ul>
        <p class="free-music-note">üéÅ All music is free to download and use!</p>
        <button id="explainer-close" class="explainer-close">
          Start Exploring
        </button>
      </div>
    </div>

    <div class="visualization-container">
      <img src="logo.png" alt="Logo" class="logo" id="logoImg" />
      <video
        src="logo.mp4"
        class="logo"
        muted
        id="logoVideo"
        style="display: none"
      ></video>
      <canvas id="spectrogram"></canvas>
      <div class="button-container">
        <button id="stopButton" class="button stop-button">Stop</button>
        <a
          href="https://buymeacoffee.com/fi4cr"
          class="button coffee-button"
          target="_blank"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.435-.6 1.5-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z"
            />
          </svg>
        </a>
      </div>
    </div>
    <div class="matrix-container" id="matrix-container"></div>
    <button id="downloadButton" aria-label="Download Current Song">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
      Download Current Track
    </button>
    <script>
      let currentRow = 0;
      let currentCol = 0;

      const countries = [
        { name: "Jamaica", flag: "üáØüá≤" },
        { name: "Spain", flag: "üá™üá∏" },
        { name: "DRC", flag: "üá®üá©" },
        { name: "China", flag: "üá®üá≥" },
        { name: "France", flag: "üá´üá∑" },
        { name: "India", flag: "üáÆüá≥" },
        { name: "Germany", flag: "üá©üá™" },
        { name: "Nigeria", flag: "üá≥üá¨" },
        { name: "Ireland", flag: "üáÆüá™" },
      ];

      const matrix = countries.map((row, i) =>
        countries.map((col, j) => (i === j ? [row] : [row, col]))
      );

      let currentAudio = null;
      let currentPlayingCell = null;
      let selectedCell = null;
      let audioContext;
      let analyser;
      let source;
      const canvas = document.getElementById("spectrogram");
      const canvasCtx = canvas.getContext("2d");

      canvas.width = 508;
      canvas.height = 150;

      let currentAudioFile = "";
      const downloadButton = document.getElementById("downloadButton");
      const stopButton = document.getElementById("stopButton");

      stopButton.addEventListener("click", stopAudio);

      downloadButton.addEventListener("click", function () {
        if (currentAudioFile) {
          const link = document.createElement("a");
          link.href = currentAudioFile;
          link.download = currentAudioFile.split("/").pop();
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      });

      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;
        }
      }

      function setupAudioVisualization(audio) {
        initAudioContext();

        if (source) {
          source.disconnect();
        }

        source = audioContext.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioContext.destination);

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

        function draw() {
          if (!currentAudio) {
            canvasCtx.fillStyle = "#e0e0e0";
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            return;
          }

          requestAnimationFrame(draw);
          analyser.getByteFrequencyData(dataArray);

          canvasCtx.fillStyle = "#e0e0e0";
          canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

          const barWidth = (canvas.width / bufferLength) * 2.5;
          let barHeight;
          let x = 0;

          for (let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i] / 2;

            const gradient = canvasCtx.createLinearGradient(
              0,
              canvas.height - barHeight,
              0,
              canvas.height
            );
            gradient.addColorStop(
              0,
              `hsla(${(i / bufferLength) * 360}, 70%, 50%, 0.8)`
            );
            gradient.addColorStop(
              1,
              `hsla(${(i / bufferLength) * 360}, 70%, 30%, 0.8)`
            );

            canvasCtx.fillStyle = gradient;
            canvasCtx.fillRect(
              x,
              canvas.height - barHeight,
              barWidth,
              barHeight
            );

            x += barWidth + 1;
          }
        }

        draw();
      }

      function generateMatrixGrid() {
        const container = document.getElementById("matrix-container");
        const numCountries = countries.length;

        container.style.gridTemplateColumns = `100px repeat(${numCountries}, 100px)`;
        container.style.gridTemplateRows = `repeat(${numCountries + 1}, 100px)`;

        // Top-left empty cell
        const topLeft = document.createElement("div");
        topLeft.classList.add("flag-cell");
        container.appendChild(topLeft);

        // Header row
        countries.forEach((country) => {
          const header = document.createElement("div");
          header.classList.add("header-cell");
          header.innerHTML = `
            <div class="country-header">
              <span>${country.name}</span>
              <span class="flag">${country.flag}</span>
            </div>
          `;
          container.appendChild(header);
        });

        // Matrix rows
        countries.forEach((rowCountry, rowIndex) => {
          // Row header
          const rowHeader = document.createElement("div");
          rowHeader.classList.add("header-cell");
          rowHeader.innerHTML = `
            <div class="country-header">
              <span>${rowCountry.name}</span>
              <span class="flag">${rowCountry.flag}</span>
            </div>
          `;
          container.appendChild(rowHeader);

          // Matrix cells
          countries.forEach((colCountry, colIndex) => {
            const cell = document.createElement("div");
            cell.classList.add("matrix-cell");
            cell.dataset.row = rowIndex;
            cell.dataset.col = colIndex;
            cell.id = `${rowCountry.name.toLowerCase()}-${colCountry.name.toLowerCase()}`;

            const cellCountries = matrix[rowIndex][colIndex];
            if (cellCountries.length === 1) {
              // Single country cell
              cell.innerHTML = `
                <div class="flags-container">
                  <span class="flag">${cellCountries[0].flag}</span>
                </div>
              `;
            } else {
              // Mixed country cell
              cell.innerHTML = `
                <div class="flags-container">
                  <span class="flag">${cellCountries[0].flag}</span>
                  <span class="plus-sign">+</span>
                  <span class="flag">${cellCountries[1].flag}</span>
                </div>
              `;
            }

            cell.onclick = () => {
              const countriesToPlay = cellCountries.map(
                (country) => country.name
              );
              playAudio(countriesToPlay, cell);
            };

            container.appendChild(cell);
          });
        });
      }

      async function findAudioFile(countries) {
        if (countries.length === 1) {
          return `${countries[0]}.mp3`;
        }

        // Try first combination
        const filename1 = `${countries[0]} ${countries[1]}.mp3`;
        try {
          const response1 = await fetch(filename1);
          if (response1.ok) return filename1;
        } catch (e) {}

        // Try reversed combination
        const filename2 = `${countries[1]} ${countries[0]}.mp3`;
        try {
          const response2 = await fetch(filename2);
          if (response2.ok) return filename2;
        } catch (e) {}

        // If neither exists, return the first filename (it will fail gracefully)
        return filename1;
      }

      function stopAudio() {
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentPlayingCell.classList.remove("playing");
          currentAudio = null;
          currentPlayingCell = null;
          downloadButton.style.display = "none";
          currentAudioFile = "";
        }
      }

      async function playAudio(countries, cell) {
        const logoVideo = document.getElementById("logoVideo");
        const logoImg = document.getElementById("logoImg");

        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          if (currentPlayingCell) {
            currentPlayingCell.classList.remove("playing");
          }
        }

        stopButton.style.display = "block";
        logoImg.style.display = "none";
        logoVideo.style.display = "block";
        logoVideo.currentTime = 0;
        logoVideo.play();

        let audioFile;
        try {
          audioFile = await findAudioFile(countries);
          currentAudioFile = audioFile;
          downloadButton.style.display = "block";
        } catch (error) {
          console.error("Error finding audio file:", error);
          // Still proceed with visual feedback even if audio fails
          selectCell(
            cell,
            parseInt(cell.dataset.row),
            parseInt(cell.dataset.col)
          );
          return;
        }

        currentAudio = new Audio(audioFile);
        currentPlayingCell = cell;

        selectCell(
          cell,
          parseInt(cell.dataset.row),
          parseInt(cell.dataset.col)
        );

        currentAudio
          .play()
          .then(() => {
            setupAudioVisualization(currentAudio);
          })
          .catch((error) => {
            console.error("Error playing audio:", error);
            if (countries.length > 1) {
              countries.reverse();
              findAudioFile(countries)
                .then((reversedAudioFile) => {
                  currentAudio = new Audio(reversedAudioFile);
                  return currentAudio.play();
                })
                .then(() => setupAudioVisualization(currentAudio))
                .catch((e) =>
                  console.error("Error playing reversed audio:", e)
                );
            }
          });

        currentAudio.onended = function () {
          cell.classList.remove("playing");
          currentAudio = null;
          currentPlayingCell = null;
          stopButton.style.display = "none";
          downloadButton.style.display = "none";
          currentAudioFile = "";
        };
      }

      function selectCell(cell, row, col) {
        if (selectedCell) {
          selectedCell.classList.remove("selected");
        }

        cell.classList.add("selected");
        cell.classList.add("playing");
        selectedCell = cell;
        currentRow = row;
        currentCol = col;
      }

      document.addEventListener("keydown", async function (event) {
        if (
          !["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(
            event.key
          )
        ) {
          return;
        }

        event.preventDefault();

        let newRow = currentRow;
        let newCol = currentCol;

        switch (event.key) {
          case "ArrowUp":
            newRow = Math.max(0, currentRow - 1);
            break;
          case "ArrowDown":
            newRow = Math.min(matrix.length - 1, currentRow + 1);
            break;
          case "ArrowLeft":
            newCol = Math.max(0, currentCol - 1);
            break;
          case "ArrowRight":
            newCol = Math.min(matrix[0].length - 1, currentCol + 1);
            break;
        }

        const nextCell = document.querySelector(
          `[data-row="${newRow}"][data-col="${newCol}"]`
        );
        if (nextCell) {
          const countriesToPlay = matrix[newRow][newCol].map(
            (country) => country.name
          );
          await playAudio(countriesToPlay, nextCell);
        }
      });

      window.onload = function () {
        generateMatrixGrid();

        // Handle explainer close
        document
          .getElementById("explainer-close")
          .addEventListener("click", function () {
            document.getElementById("explainer-overlay").style.display = "none";

            // Play random cell after closing explainer
            setTimeout(() => {
              const randomRow = Math.floor(Math.random() * matrix.length);
              const randomCol = Math.floor(Math.random() * matrix[0].length);
              const randomCell = document.querySelector(
                `[data-row="${randomRow}"][data-col="${randomCol}"]`
              );
              const countriesToPlay = matrix[randomRow][randomCol].map(
                (country) => country.name
              );
              playAudio(countriesToPlay, randomCell);
            }, 500);
          });
      };
    </script>
  </body>
</html>
